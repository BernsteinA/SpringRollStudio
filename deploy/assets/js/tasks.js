!function(a){var b=require("nw.gui"),c=function(){this.main=null,this.main=b.Window.get(),this.main.on("close",this.shutdown.bind(this))};c.create=function(b){a(function(){window.module=new b})};var d=c.prototype;d.focus=function(){},d.shutdown=function(){this.close(!0)},d.close=function(a){this.main.close(a),this.main=null},namespace("springroll").Module=c}(jQuery),function(){var a=require("MD5"),b=require("fs"),c={};c.templates={},c.getTemplate=function(a,d){if(c.templates[a])return _.template(c.templates[a])(d);var e=b.readFileSync("assets/templates/"+a+".html",{encoding:"utf-8"});return c.templates[a]=e,_.template(e)(d)},c.uid=function(b){return a(((new Date).toISOString()+b).toLowerCase().replace(/\\/gi,"/")).substr(8,8)},namespace("springroll.tasks").Utils=c}(),function(){var a={};Object.defineProperty(a,"activeProject",{get:function(){return localStorage.TasksDataActive||null},set:function(a){localStorage.TasksDataActive=a}}),Object.defineProperty(a,"collapsedSidebar",{get:function(){return JSON.parse(localStorage.TasksDataSidebar||"false")},set:function(a){localStorage.TasksDataSidebar=JSON.stringify(a)}}),a.setProjects=function(a){localStorage.TasksData=JSON.stringify(a)},a.getProjects=function(){var a;try{a=JSON.parse(localStorage.TasksData||"[]")}catch(b){alert("Error Reading Tasks! Reverting to defaults.")}return a||[]},a.saveWindow=function(a,b){localStorage[a]=JSON.stringify({width:b.width,height:b.height,x:b.x,y:b.y})},a.loadWindow=function(a,b){var c;try{c=JSON.parse(localStorage[a]||"null")}catch(d){alert("Error Reading Spock Window! Reverting to defaults.")}c&&(b.width=c.width,b.height=c.height,b.x=c.x,b.y=c.y)},namespace("springroll.tasks").Settings=a}(),function(){var a=require("nw.gui"),b=springroll.tasks.Settings,c=function(a,b){this.projectId=a,this.taskName=b,this.output=null,this.terminal=null,this.main=null,this.observer=null,this.create()},d=c.prototype={},e="TasksTerminalWindow";d.create=function(){this.main=a.Window.get(window.open("tasks-terminal.html"),{show:!1}),this.main.on("close",this.close.bind(this)),this.main.on("loaded",this.onLoaded.bind(this))},d.onLoaded=function(){b.loadWindow(e,this.main),this.terminal=this.main.window.document.getElementById("terminal"),this.observer=new MutationObserver(this.onUpdate.bind(this)),this.open(this.projectId,this.taskName)},d.onUpdate=function(){this.terminal.innerHTML=this.output.innerHTML,this.terminal.scrollTop=this.terminal.scrollHeight},d.open=function(a,b){this.observer&&this.observer.disconnect(),this.terminal.innerHTML="",this.projectId=a,this.taskName=b,this.output=document.getElementById("console_"+a+"_"+b),this.main.title=this.taskName,this.observer.observe(this.output,{attributes:!0,childList:!0,characterData:!0}),this.onUpdate(),this.main.show(),this.main.focus()},d.close=function(){this.observer&&this.observer.disconnect(),this.output=null,this.terminal.innerHTML="",b.saveWindow(e,this.main),this.main.hide()},d.destroy=function(){this.close(),this.observer=null,this.terminal=null,this.main.close(!0),this.main=null},namespace("springroll.tasks").TerminalWindow=c}(),function(){var a=require("fs"),b=require("path"),c=springroll.tasks.TerminalWindow,d=springroll.tasks.Settings,e=function(e){var g=$("body").on("click",".JS-Sidebar-Item",function(){return e.switchProject($(this).data("id").toString()),!1}).on("click",".JS-Project-Remove",function(){return e.removeProject($(this).data("id").toString()),!1}).on("dblclick",".JS-Task-Toggle-Info",function(){var a=$(this).find(".JS-Task-Run"),b=a.data("project-id").toString(),c=a.data("task-name").toString();return e.runTask(b,c),!1}).on("click",".JS-Task-Run",function(){var a=$(this).data("project-id").toString(),b=$(this).data("task-name").toString();return e.runTask(a,b),!1}).on("click",".JS-Task-Terminal",function(){var a=$(this).data("project-id").toString(),b=$(this).data("task-name").toString();return e.terminal?e.terminal.open(a,b):e.terminal=new c(a,b),!1}).on("click",".JS-Task-Stop",function(){var a=$(this).data("project-id").toString(),b=$(this).data("task-name").toString();return e.stopTask(a,b),!1});$(".sidebar-toggle").click(function(){collapsed=g.toggleClass(f).hasClass(f),d.collapsedSidebar=collapsed}),d.collapsedSidebar&&g.addClass(f),$(".sidebar-list").sortable().on("sortupdate",function(){var a=[];$(".sidebar-item").each(function(){a.push($(this).data("id").toString())}),e.projectManager.reorder(a)}),$(document).on("dragover",function(a){a.stopPropagation(),a.preventDefault()}).on("drop",function(c){c.stopPropagation(),c.preventDefault();var d=c.originalEvent.dataTransfer.files;return _.each(d,function(c){var d=a.statSync(c.path);d.isDirectory()&&b.dirname(c.path)!==c.path?e.addProject(c.path):d.isFile()&&b.dirname(b.dirname(c.path))!==b.dirname(c.path)&&e.addProject(b.dirname(c.path))}),!1})},f="collapsed-sidebar";namespace("springroll.tasks").Interface=e}(),function(){var a=require("child_process").exec,b=require("path"),c=require("fs"),d=springroll.tasks.Utils,e=springroll.tasks.Settings,f=function(a){this.app=a,this.projects=e.getProjects()},g=f.prototype={};g.add=function(e,f,g,h){var i,j=this;if(_.each(this.projects,function(a){b.relative(a.path,e)||(i=a,i.exists=!0)}),!i){var k=b.basename(e);i={id:d.uid(k),name:k,path:e,tasks:null,exists:!1}}f(i),c.existsSync(b.join(i.path,"node_modules"))?j.proceed(i,g,h):a("npm install",{cwd:i.path},function(a){a?g(i.id,"npm install error: "+a):j.proceed(i,g,h)})},g.proceed=function(d,e,f){var g=this;if(!c.existsSync(b.join(d.path,"node_modules/grunt")))return void e(d.id,"Unable to find local grunt.");if(!c.existsSync(b.join(d.path,"Gruntfile.js")))return void e(d.id,"Unable to find Gruntfile.js.");var h=function(){a("grunt -h",{cwd:d.path},function(a,b){if(a)return void e(d.id,"exec error: "+a);var c=/Available tasks/,h=/\n\nTasks run in the order specified/,i=b.search(c),j=b.search(h);if(-1===i)return void e(d.id,"There was a problem fetching tasks");var k=[],l=b.substring(i,j).split("\n"),m=/^\s*[a-zA-Z0-9\-]+\s{2}.*\s*$/,n=/\*\s*$/,o=null;l.shift(),_.each(l,function(a,b){if(!n.test(a)&&m.test(a)){if(!o){var c=a.match(/^\s*[a-zA-Z0-9\-]+\s{2}/);o=c[0].length}for(var d=a.substr(0,o).trim(),e=a.substr(o).trim(),f=b+1;l[f]&&!m.test(l[f]);)e+=" "+l[f].trim(),f++;k.push({name:d,info:e.replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")})}}),g.addTasks(d,k),f(d)})};a("grunt _spock_usertasks",{cwd:d.path},function(a,b){if(a)return void h();var c,e=b.split("\n");try{c=JSON.parse(e[1])}catch(i){c=[]}g.addTasks(d,c),f(d)})},g.addTasks=function(a,b){a.tasks=b||[];var c=a.exists;delete a.exists,c||(this.projects.push(a),e.setProjects(this.projects))},g.reorder=function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.getById(a[c]));this.projects=b,e.setProjects(this.projects)},g.remove=function(a){this.projects=_.reject(this.projects,function(b){return b.id===a}),e.setProjects(this.projects),this.app.terminalManager.killProjectWorkers(a)},g.getById=function(a){return _.find(this.app.projectManager.projects,function(b){return b.id===a})},g.getByPath=function(a){return _.find(this.app.projectManager.projects,function(b){return b.path===a})},namespace("springroll.tasks").ProjectManager=f}(),function(){var a=require("child_process").spawn,b=require("child_process").exec,c=function(a){this.app=a,this.command="win32"===process.platform?"grunt.cmd":"grunt",this.process_list={}},d=c.prototype;d.killWorkers=function(){var a=this;_.forEach(a.process_list,function(b,c){a.killProjectWorkers(c)})},d.killProjectWorkers=function(a){var b=this,c=this.process_list[a];c&&_.forEach(c,function(c,d){"running"===c.status&&b.killTask(a,d)})},d.runTask=function(b,c,d,e,f){var g=this.app.projectManager.getById(b);d();var h=a(this.command,[c],{cwd:g.path});_.isUndefined(this.process_list[b])&&(this.process_list[b]={}),this.process_list[b][c]={name:c,terminal:h,status:"running"};var i=this.app;h.stdout.setEncoding("utf8"),h.stdout.on("data",function(a){i.putCliLog(a,b,c)}),h.stderr.on("data",function(a){i.putCliLog(a,b,c),f()}),h.on("close",function(){e(),h.status="stop"})},d.stopTask=function(a,b){if(!_.isUndefined(this.process_list[a]))try{this.killTask(a,b);{this.process_list[a][b].status="stop"}}catch(c){alert("process end error!")}},d.killTask=function(a,c){if("win32"===process.platform){var d=this.process_list[a][c].terminal.pid;b("taskkill /pid "+d+" /T /F")}else this.process_list[a][c].terminal.kill()},namespace("springroll.tasks").TerminalManager=c}(),function(a){var b=require("ansi2html"),c=require("node-watch"),d=require("path"),e=springroll.Module,f=springroll.tasks.Settings,g=springroll.tasks.ProjectManager,h=(springroll.tasks.TerminalWindow,springroll.tasks.Interface),i=springroll.tasks.Utils,j=springroll.tasks.TerminalManager,k=function(){e.call(this),this.sidebar=a(".sidebar-list"),this.tasks=a(".task-tab"),this.projectManager=new g(this),this.terminalManager=new j(this),this.ui=new h(this),this.terminal=null,this.init()},l=k.prototype=Object.create(e.prototype);l.init=function(){var a=this,b=this.projectManager;if(b.projects.length>0){var c,d=f.activeProject,e=!1;_.each(b.projects,function(f,g,h){b.add(f.path,a.initProject.bind(a),a.clearProject,function(b){c||(c=b.id),b&&a.addedProject(b),lastId=b.id,d&&b.id===d&&(e=!0),g+1===h.length&&(e||(d=c),a.switchProject(d))})})}},l.addProject=function(a){var b=this;this.projectManager.add(a,this.initProject.bind(this),function(a,c){alert(c),b.clearProject(a)},function(a){b.addedProject(a),b.switchProject(a.id)})},l.watchProject=function(a){var b=this;c(d.join(a,"Gruntfile.js"),function(){var c=b.projectManager.getByPath(a);c&&(b.removeProject(c.id),b.addProject(a))})},l.initProject=function(b){this.clearProject(b.id);var c=i.getTemplate("project",b);a(c).appendTo(this.sidebar)},l.addedProject=function(b){a("#project_"+b.id).removeClass("loading"),a(i.getTemplate("tasks",b)).appendTo(this.tasks),this.watchProject(b.path)},l.switchProject=function(b){a(".sidebar-item_current").removeClass("sidebar-item_current"),a("#project_"+b).addClass("sidebar-item_current"),a(".tasks").hide(),a("#tasks_"+b).show(),f.activeProject=b},l.clearProject=function(b){a("#project_"+b+", #tasks_"+b).remove()},l.removeProject=function(b){this.projectManager.remove(b),this.clearProject(b),0===a(".sidebar-item_current").length&&this.projectManager.projects.length>0&&this.switchProject(this.projectManager.projects[0].id)},l.putCliLog=function(c,d,e){var f=b(c);a("<p>"+f+"</p>").appendTo(a("#console_"+d+"_"+e)),this.terminalScrollToBottom(d,e)},l.terminalScrollToBottom=function(b,c){_.throttle(function(){a("#console_"+b+"_"+c).scrollTop(999999999)},100)()},l.runTask=function(b,c){var d="#task_item_"+b+"_"+c;this.terminalManager.runTask(b,c,function(){a(d).addClass("tasks-item_running").removeClass("tasks-item_error"),a(d+" .tasks-action-item_terminal").show(),a(d+" .tasks-action-item_stop").show(),a(d+" .tasks-action-item_run").hide()},function(){a(d).removeClass("tasks-item_running"),a(d+" .tasks-action-item_terminal").hide(),a(d+" .tasks-action-item_stop").hide(),a(d+" .tasks-action-item_run").show()},function(){a(d).addClass("tasks-item_error").removeClass("tasks-item_running"),a(d+" .tasks-action-item_terminal").hide(),a(d+" .tasks-action-item_stop").hide(),a(d+" .tasks-action-item_run").show()})},l.stopTask=function(b,c){this.terminalManager.stopTask(b,c),a("#task_item_"+b+"_"+c).removeClass("tasks-item_running"),a("#task_item_"+b+"_"+c).removeClass("tasks-item_error"),a("#task_item_"+b+"_"+c+" .tasks-action-item_terminal").hide(),a("#task_item_"+b+"_"+c+" .tasks-action-item_stop").hide(),a("#task_item_"+b+"_"+c+" .tasks-action-item_run").show()},l.shutdown=function(){this.terminal&&this.terminal.destroy(),this.terminalManager.killWorkers(),this.close(!0)},e.create(k)}(jQuery);